<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–©–æ –ø—Ä–∏–≥–æ—Ç—É–≤–∞—Ç–∏? ‚Äî Dark Kitchen Plus: Student Edition (Final)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b0c0d; --panel:#0f1112; --muted:#9aa0a6; --text:#e8eaed;
    --accent:#ffb84d; --accent-strong:#ff7a2d;
    --glass: rgba(255,255,255,0.03);
    --radius:14px; --card-shadow: 0 10px 30px rgba(2,6,23,0.6);
    --maxw:1200px;
  }

  /* Light theme variables (overridden when body.light present) */
  body.light{
    --bg:#f6f7f9; --panel:linear-gradient(180deg,#ffffff,#fbfbfb);
    --muted:#6b6b6b; --text:#111827; --accent:#f6c466; --accent-strong:#ea8a3a;
    --card-shadow: 0 12px 28px rgba(12,18,26,0.08);
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;font-family:Inter,system-ui,Arial;background:var(--bg);color:var(--text);
    -webkit-font-smoothing:antialiased;display:flex;justify-content:center;padding:28px;
  }

  .container{width:100%;max-width:var(--maxw);display:grid;grid-template-columns:1fr 360px;gap:22px;align-items:start;}
  header{grid-column:1/-1;display:flex;justify-content:space-between;align-items:center;gap:12px}
  .brand{display:flex;align-items:center;gap:14px}
  .logo{width:64px;height:64px;border-radius:16px;background:linear-gradient(135deg,var(--accent),var(--accent-strong));display:flex;align-items:center;justify-content:center;font-weight:800;color:#221813;font-size:28px;box-shadow:0 8px 30px rgba(0,0,0,0.35)}
  h1{margin:0;font-size:20px}
  .sub{color:var(--muted);font-size:13px}

  /* main panels */
  .panel{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:18px;border-radius:var(--radius);box-shadow:var(--card-shadow);transition:all .22s}
  body.light .panel{background:var(--panel);}

  .fun{font-size:14px;color:var(--muted);margin-bottom:12px}
  .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px}
  input[type="text"], select{width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit;font-size:15px;outline:none}
  body.light input[type="text"], body.light select{border:1px solid rgba(0,0,0,0.06)}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{background:var(--glass);padding:8px 12px;border-radius:999px;color:var(--muted);font-size:13px;display:inline-flex;gap:8px;align-items:center}
  .chip button{background:none;border:0;color:inherit;cursor:pointer;font-size:13px}

  .btn{padding:10px 14px;border-radius:12px;border:0;font-weight:700;cursor:pointer}
  .btn-accent{background:linear-gradient(180deg,var(--accent),var(--accent-strong));color:#221813}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}

  /* results */
  .results{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px;margin-top:12px}
  .card{background:rgba(255,255,255,0.02);padding:12px;border-radius:12px;position:relative;overflow:hidden;transition:transform .18s,box-shadow .18s}
  .card:hover{transform:translateY(-8px);box-shadow:0 22px 60px rgba(0,0,0,0.6)}
  .thumb{height:120px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));display:flex;align-items:center;justify-content:center;font-size:44px}
  .title{font-weight:700;margin-top:10px}
  .meta{color:var(--muted);font-size:13px;margin-top:6px}
  .missing{margin-top:8px;color:#ffdcb0;font-size:13px}
  .actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
  .small{padding:6px 10px;border-radius:10px;background:rgba(255,255,255,0.02);cursor:pointer;font-size:13px}
  .match{position:absolute;right:12px;top:12px;background:rgba(0,0,0,0.35);padding:6px 8px;border-radius:10px;font-size:13px}

  /* sidebar */
  .sidebar{position:sticky;top:28px;display:flex;flex-direction:column;gap:14px}
  .side-section{padding:12px;border-radius:12px;background:var(--panel);box-shadow:var(--card-shadow)}

  /* dialog overlay */
  .overlay{position:fixed;inset:0;background:linear-gradient(180deg, rgba(2,6,9,0.65), rgba(2,6,9,0.85));display:flex;align-items:center;justify-content:center;z-index:9999}
  .dialog{width:96%;max-width:760px;background:linear-gradient(180deg,#0f1112,#0b0c0d);border-radius:16px;padding:22px;color:var(--text);box-shadow:0 40px 120px rgba(0,0,0,0.7);animation:pop .26s ease}
  @keyframes pop{from{transform:translateY(12px) scale(.98);opacity:0}to{transform:none;opacity:1}}
  .step{display:none}
  .step.active{display:block}
  .options{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
  .option{min-width:120px;padding:12px;border-radius:12px;background:rgba(255,255,255,0.02);cursor:pointer;text-align:center;border:1px solid transparent;transition:all .18s}
  .option:hover{transform:translateY(-6px);border-color:rgba(255,255,255,0.04)}
  .option.selected{background:linear-gradient(180deg,var(--accent),var(--accent-strong));color:#221813}
  .foot{display:flex;justify-content:space-between;align-items:center;margin-top:18px}
  .small-muted{font-size:13px;color:var(--muted)}

  /* utilities */
  .hidden{display:none}
  .muted{color:var(--muted)}
  .badge{background:rgba(255,255,255,0.03);padding:6px 10px;border-radius:999px;font-size:13px;color:var(--muted)}
  .reopen{background:transparent;border:1px dashed rgba(255,255,255,0.06);padding:8px 12px;border-radius:10px;color:var(--muted);cursor:pointer}
  
  /* Quick Cooker Select in Sidebar */
  #quick-cooker-select .option, #category-filter-list .option{
    min-width: unset; 
    padding: 8px 12px; 
    font-size: 13px;
    background: rgba(255,255,255,0.02);
  }
  #quick-cooker-select .option.selected, #category-filter-list .option.selected{
    background: linear-gradient(180deg, var(--accent), var(--accent-strong));
    color: #221813;
  }

  /* responsive */
  @media (max-width:1024px){ .container{grid-template-columns:1fr} .sidebar{position:static} }
</style>
</head>
<body>
  <div id="overlay" class="overlay">
    <div class="dialog">
      <div id="step-welcome" class="step active">
        <h2>üçú –ü—Ä–∏–≤—ñ—Ç, –±—ñ–¥–æ–ª–∞–≥–∞!</h2>
        <p class="small-muted">–Ø ‚Äî Dark Kitchen Plus, —Ç–≤—ñ–π –≥—É—Ä—Ç–æ–∂–∏—Ç—Å—å–∫–∏–π —à–µ—Ñ. –ü—Ä–æ–π–¥–µ–º–æ –∫—ñ–ª—å–∫–∞ –ø–∏—Ç–∞–Ω—å, —â–æ–±–∏ –∑–Ω–∞–π—Ç–∏, —â–æ –≥–æ—Ç—É–≤–∞—Ç–∏.</p>
        <div class="foot">
          <div class="small-muted">–°—Ç–∞—Ç–∏—á–Ω–∏–π –¥—ñ–∞–ª–æ–≥ ‚Äî –ø—Ä–æ—Å—Ç–æ –æ–±–∏—Ä–∞–π.</div>
          <div><button id="to-meal" class="btn btn-accent">–†–æ–∑–ø–æ—á–∞—Ç–∏</button></div>
        </div>
      </div>

      <div id="step-meal" class="step">
        <h2>–ö–æ–ª–∏ –≥–æ—Ç—É—î–º–æ?</h2>
        <div class="options" id="meal-options">
          <div class="option" data-val="breakfast">üç≥ –°–Ω—ñ–¥–∞–Ω–æ–∫</div>
          <div class="option" data-val="lunch">üçù –û–±—ñ–¥</div>
          <div class="option" data-val="dinner">üåô –í–µ—á–µ—Ä—è</div>
          <div class="option" data-val="late">üåö –ù—ñ—á–Ω–∞ —à–∞—É—Ä–º–∞</div>
        </div>
        <div class="foot">
          <div class="small-muted">–û–±–µ—Ä—ñ—Ç—å –æ–¥–∏–Ω –≤–∞—Ä—ñ–∞–Ω—Ç</div>
          <div><button id="meal-next" class="btn btn-accent" disabled>–î–∞–ª—ñ ‚Üí</button></div>
        </div>
      </div>

      <div id="step-cooker" class="step">
        <h2>–ù–∞ —á–æ–º—É –≥–æ—Ç—É—î–º–æ?</h2>
        <div class="options" id="cooker-options">
          <div class="option" data-val="gas">üî• –ì–∞–∑–æ–≤–∞ –ø–ª–∏—Ç–∞</div>
          <div class="option" data-val="electric">‚ö° –ï–ª–µ–∫—Ç—Ä–∏—á–Ω–∞ –ø–ª–∏—Ç–∞</div>
          <div class="option" data-val="pan">üç≥ –ü–∞—Ç–µ–ª—å–Ω—è</div>
          <div class="option" data-val="pot">üç≤ –ö–∞—Å—Ç—Ä—É–ª—è</div>
          <div class="option" data-val="multi">ü§ñ –ú—É–ª—å—Ç–∏–≤–∞—Ä–∫–∞</div>
          <div class="option" data-val="kazan">ü•£ –ö–∞–∑–∞–Ω (–ø–ª–æ–≤ –Ω–∞ —Ç–∏–∂–¥–µ–Ω—å)</div>
          <div class="option" data-val="micro">üì° –ú—ñ–∫—Ä–æ—Ö–≤–∏–ª—å–æ–≤–∫–∞</div>
          <div class="option" data-val="none">‚òï –¢—ñ–ª—å–∫–∏ —á–∞–π–Ω–∏–∫</div>
        </div>

        <div style="margin-top:12px;display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <div class="badge" id="speed-badge">‚è± –®–≤–∏–¥–∫—ñ—Å—Ç—å: <strong id="speed-text">–ù–æ—Ä–º–∞–ª—å–Ω–æ</strong></div>
          <div class="options" style="margin-left:auto">
            <div class="option" id="speed-fast" data-val="fast">‚ö° –ü–æ–±—ã—Å—Ç—Ä–µ–µ</div>
            <div class="option selected" id="speed-normal" data-val="normal">üòå –ù–æ—Ä–º–∞–ª—å–Ω–æ</div>
            <div class="option" id="speed-slow" data-val="slow">üê¢ –ü–æ–≤—ñ–ª—å–Ω–æ (—Å—Ç–∞—Ä–∞–Ω–Ω–æ)</div>
          </div>
        </div>

        <div class="foot">
          <div id="cooker-hint" class="small-muted">–ü—ñ—Å–ª—è –≤–∏–±–æ—Ä—É –ø–æ–±–∞—á–∏—à –∂–∞—Ä—Ç—ñ–≤–ª–∏–≤—É –ø—ñ–¥–∫–∞–∑–∫—É.</div>
          <div><button id="cooker-next" class="btn btn-accent" disabled>–î–∞–ª—ñ ‚Üí</button></div>
        </div>
      </div>

      <div id="step-summary" class="step">
        <h2>–ì–æ—Ç–æ–≤–æ! –ö–æ—Ä–æ—Ç–∫–µ —Ä–µ–∑—é–º–µ</h2>
        <p id="summary" class="muted"></p>
        <div class="foot">
          <div class="small-muted">–ú–æ–∂–Ω–∞ –∑–º—ñ–Ω–∏—Ç–∏ –≤ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è—Ö –ø—ñ–∑–Ω—ñ—à–µ</div>
          <div><button id="finish" class="btn btn-accent">–ü–µ—Ä–µ–π—Ç–∏ –¥–æ –¥–æ–¥–∞—Ç–∫—É</button></div>
        </div>
      </div>
    </div>
  </div>

  <div class="container" id="app" style="opacity:0;transform:translateY(8px);transition:all .36s">
    <header>
      <div class="brand">
        <div class="logo">üç≥</div>
        <div>
          <h1>–©–æ –ø—Ä–∏–≥–æ—Ç—É–≤–∞—Ç–∏?</h1>
          <div class="sub">Dark Kitchen Plus ‚Äî Student Edition ‚Ä¢ <span id="selected-meal" class="muted">‚Äî</span> ‚Ä¢ <span id="selected-cooker" class="muted">‚Äî</span></div>
        </div>
      </div>

      <div style="display:flex;gap:10px;align-items:center">
        <button id="reopen-dialog" class="reopen" title="–ó–º—ñ–Ω–∏—Ç–∏ –≤–∏–±—ñ—Ä">üîÅ –ó–º—ñ–Ω–∏—Ç–∏ –≤–∏–±—ñ—Ä</button>
        <button id="theme-toggle" class="reopen" title="–¢–µ–º–∞">üåô</button>
        <button id="random-btn" class="reopen" title="–í–∏–ø–∞–¥–∫–æ–≤–∞ —Å—Ç—Ä–∞–≤–∞">üé≤</button>
      </div>
    </header>

    <main>
      <section class="panel">
        <div class="fun" id="fun-msg">–ü—Ä–∏–≤—ñ—Ç! –ü—Ä–æ–π—à–ª–∏ –¥—ñ–∞–ª–æ–≥ ‚Äî —Ç–µ–ø–µ—Ä –¥–æ–¥–∞–≤–∞–π —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏ –∞–±–æ –Ω–∞—Ç–∏—Å–∫–∞–π ¬´–í–∏–ø–∞–¥–∫–æ–≤–∞¬ª.</div>

        <h3>–©–æ —î —É —Ç–µ–±–µ –≤–¥–æ–º–∞?</h3>
        <div class="chips" id="chips"></div>
        <input id="ingredient-input" type="text" placeholder="–í–≤–µ–¥–∏ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏ —á–µ—Ä–µ–∑ –∫–æ–º—É (–Ω–∞—Ç–∏—Å–Ω–∏ Enter)"/>

        <div class="controls">
          <button id="find-btn" class="btn btn-accent">–ó–Ω–∞–π—Ç–∏ —Ä–µ—Ü–µ–ø—Ç–∏</button>
          <button id="clear-btn" class="btn btn-ghost">–û—á–∏—Å—Ç–∏—Ç–∏</button>
          <select id="filter-diff">
            <option value="">–£—Å—ñ —Å–∫–ª–∞–¥–Ω–æ—Å—Ç—ñ</option>
            <option value="–õ–µ–≥–∫–æ">–õ–µ–≥–∫–æ</option>
            <option value="–°–µ—Ä–µ–¥–Ω—å–æ">–°–µ—Ä–µ–¥–Ω—å–æ</option>
            <option value="–í–∞–∂–∫–æ">–í–∞–∂–∫–æ</option>
          </select>
          <div class="badge" id="speed-current">‚è± –®–≤–∏–¥–∫—ñ—Å—Ç—å: <strong id="speed-current-text">–ù–æ—Ä–º–∞–ª—å–Ω–æ</strong></div>
        </div>
      </section>

      <section class="panel" style="margin-top:16px">
        <h3>–ü–æ—à—É–∫ —Å—Ç—Ä–∞–≤–∏</h3>
        <input id="search-input" type="text" placeholder="–í–≤–µ–¥–∏ –Ω–∞–∑–≤—É —Å—Ç—Ä–∞–≤–∏"/>
      </section>

      <section class="panel" style="margin-top:16px">
        <h3>–§—ñ–ª—å—Ç—Ä–∏ (–î—ñ—î—Ç–∏—á–Ω—ñ)</h3>
        <label style="display:block;margin-bottom:6px"><input type="checkbox" class="diet" value="vegan"> –í–µ–≥–∞–Ω</label>
        <label style="display:block;margin-bottom:6px"><input type="checkbox" class="diet" value="glutenfree"> –ë–µ–∑–≥–ª—é—Ç–µ–Ω–æ–≤–µ</label>
        <label style="display:block"><input type="checkbox" class="diet" value="vegetarian"> –í–µ–≥–µ—Ç–∞—Ä—ñ–∞–Ω—Å—å–∫–µ</label>
      </section>

      <section id="history" class="panel" style="margin-top:16px"></section>

      <section style="margin-top:16px">
        <h3>–†–µ—Ü–µ–ø—Ç–∏</h3>
        <div id="results" class="results panel"></div>
      </section>
    </main>

    <aside class="sidebar">
      
      <div class="side-section panel">
        <h4>–ö–∞—Ç–µ–≥–æ—Ä—ñ—ó —Å—Ç—Ä–∞–≤</h4>
        <div class="options" id="category-filter-list" style="margin-top:8px">
          <div class="option" data-val="oriental">üèÆ –°—Ö—ñ–¥–Ω—ñ</div>
          <div class="option" data-val="spicy">üå∂Ô∏è –ì–æ—Å—Ç—Ä—ñ</div>
          <div class="option" data-val="quick">üöÄ –®–≤–∏–¥–∫—ñ (–¥–æ 25 —Ö–≤)</div>
          <div class="option" data-val="student">üéì –°—Ç—É–¥–µ–Ω—Ç—Å—å–∫–∞ –ö–ª–∞—Å–∏–∫–∞</div>
        </div>
      </div>
      
      <div class="side-section panel">
        <h4>–®–≤–∏–¥–∫–∞ –∑–º—ñ–Ω–∞ –ø–æ—Å—É–¥—É/–ø–ª–∏—Ç–∏</h4>
        <div class="options" id="quick-cooker-select">
          <div class="option" data-val="gas">üî• –ü–ª–∏—Ç–∞ (–≥–∞–∑)</div>
          <div class="option" data-val="electric">‚ö° –ü–ª–∏—Ç–∞ (–µ–ª.)</div>
          <div class="option" data-val="pan">üç≥ –ü–∞—Ç–µ–ª—å–Ω—è</div>
          <div class="option" data-val="pot">üç≤ –ö–∞—Å—Ç—Ä—É–ª—è</div>
          <div class="option" data-val="multi">ü§ñ –ú—É–ª—å—Ç–∏–≤–∞—Ä–∫–∞</div>
          <div class="option" data-val="kazan">ü•£ –ö–∞–∑–∞–Ω</div>
          <div class="option" data-val="micro">üì° –ú—ñ–∫—Ä–æ—Ö–≤.</div>
          <div class="option" data-val="none">‚òï –ß–∞–π–Ω–∏–∫</div>
        </div>
      </div>
      
      <div class="side-section panel">
        <h4>–°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫</h4>
        <ul id="shopping-list"><li>–ü–æ—Ä–æ–∂–Ω—å–æ</li></ul>
      </div>

      <div class="side-section panel">
        <h4>–£–ª—é–±–ª–µ–Ω–µ</h4>
        <ul id="favorites-list"><li>–ü—É—Å—Ç–æ</li></ul>
      </div>

      <div class="side-section panel">
        <h4>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —à–≤–∏–¥–∫–æ—Å—Ç—ñ</h4>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
          <button class="btn btn-ghost" id="ui-speed-fast">‚ö° –ü–æ–±—ã—Å—Ç—Ä–µ–µ</button>
          <button class="btn btn-ghost" id="ui-speed-normal">üòå –ù–æ—Ä–º–∞–ª—å–Ω–æ</button>
          <button class="btn btn-ghost" id="ui-speed-slow">üê¢ –ü–æ–≤—ñ–ª—å–Ω–æ</button>
        </div>
      </div>
    </aside>
  </div>

<script>
/* ---------- –†–µ—Ü–µ–ø—Ç–∏ (–æ–Ω–æ–≤–ª–µ–Ω–æ) ---------- */
const RECIPES = [
 {id:'r1',title:'–Ø—î—á–Ω—è –∑ –∫–∞—Ä—Ç–æ–ø–ª–µ—é',ingredients:['—è–π—Ü—è','–∫–∞—Ä—Ç–æ–ø–ª—è','—Å—ñ–ª—å','–º–∞—Å–ª–æ'],time:15,difficulty:'–õ–µ–≥–∫–æ',diet:[],categories:['quick','student'],steps:['–ù–∞—Ä—ñ–∑–∞—Ç–∏ –∫–∞—Ä—Ç–æ–ø–ª—é –π –ø—ñ–¥—Å–º–∞–∂–∏—Ç–∏.','–î–æ–¥–∞—Ç–∏ —è–π—Ü—è —Ç–∞ –º–∞—Å–ª–æ.']},
 {id:'r2',title:'–û–≤–æ—á–µ–≤–µ —Ä–∞–≥—É',ingredients:['–∫–∞—Ä—Ç–æ–ø–ª—è','–º–æ—Ä–∫–≤–∞','—Ü–∏–±—É–ª—è','–ø–æ–º—ñ–¥–æ—Ä','–∫–∞–±–∞—á–æ–∫'],time:40,difficulty:'–°–µ—Ä–µ–¥–Ω—å–æ',diet:['vegan','glutenfree'],categories:['student'],steps:['–û–±—Å–º–∞–∂–∏—Ç–∏ –æ–≤–æ—á—ñ, —Ç—É—à–∫—É–≤–∞—Ç–∏ –∑ —Ç–æ–º–∞—Ç–æ–º.']},
 {id:'r3',title:'–ü–∞—Å—Ç–∞ –∑ —Å–æ—É—Å–æ–º',ingredients:['–º–∞–∫–∞—Ä–æ–Ω–∏','–ø–æ–º—ñ–¥–æ—Ä','—á–∞—Å–Ω–∏–∫','—Å–∏—Ä'],time:25,difficulty:'–õ–µ–≥–∫–æ',diet:['vegetarian'],categories:['quick','student'],steps:['–ó–≤–∞—Ä–∏—Ç–∏ –º–∞–∫–∞—Ä–æ–Ω–∏.','–ó—Ä–æ–±–∏—Ç–∏ —Å–æ—É—Å.','–ó–º—ñ—à–∞—Ç–∏.']},
 {id:'r4',title:'–°–∞–ª–∞—Ç –∑ –æ–≤–æ—á—ñ–≤',ingredients:['–æ–≥—ñ—Ä–æ–∫','–ø–æ–º—ñ–¥–æ—Ä','—Ü–∏–±—É–ª—è','–æ–ª—ñ—è'],time:10,difficulty:'–õ–µ–≥–∫–æ',diet:['vegan','glutenfree'],categories:['quick'],steps:['–ù–∞—Ä—ñ–∑–∞—Ç–∏ –æ–≤–æ—á—ñ, –∑–∞–ø—Ä–∞–≤–∏—Ç–∏ –æ–ª—ñ—î—é.']},
 {id:'r5',title:'–ì–æ—Å—Ç—Ä—ñ –∫—É—Ä—è—á—ñ —Å—Ç–µ–≥–µ–Ω—Ü—è',ingredients:['–∫—É—Ä–∫–∞','—á–∞—Å–Ω–∏–∫','–ø–∞–ø—Ä–∏–∫–∞','–ø–µ—Ä–µ—Ü—å —á–∏–ª—ñ','—Å–æ—î–≤–∏–π —Å–æ—É—Å'],time:60,difficulty:'–í–∞–∂–∫–æ',diet:['glutenfree'],categories:['spicy'],steps:['–ó–∞–º–∞—Ä–∏–Ω—É–≤–∞—Ç–∏ –≤ –≥–æ—Å—Ç—Ä–æ–º—É —Å–æ—É—Å—ñ.','–ó–∞–ø–µ–∫—Ç–∏.']},
 {id:'r6',title:'–û–º–ª–µ—Ç –∑ –æ–≤–æ—á–∞–º–∏',ingredients:['—è–π—Ü—è','–ø–æ–º—ñ–¥–æ—Ä','—Ü–∏–±—É–ª—è','–º–∞—Å–ª–æ'],time:12,difficulty:'–õ–µ–≥–∫–æ',diet:['vegetarian'],categories:['quick','student'],steps:['–ó–±–∏—Ç–∏ —è–π—Ü—è.','–î–æ–¥–∞—Ç–∏ –æ–≤–æ—á—ñ –Ω–∞ —Å–∫–æ–≤–æ—Ä—ñ–¥–∫—É.','–°–º–∞–∂–∏—Ç–∏ –¥–æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—ñ.']},
 {id:'r7',title:'–ü–∞—Å—Ç–∞ –∫–∞—Ä–±–æ–Ω–∞—Ä–∞',ingredients:['–º–∞–∫–∞—Ä–æ–Ω–∏','—è–π—Ü—è','—Å–∏—Ä','–±–µ–∫–æ–Ω'],time:20,difficulty:'–°–µ—Ä–µ–¥–Ω—å–æ',diet:[],categories:['student'],steps:['–ó–≤–∞—Ä–∏—Ç–∏ –ø–∞—Å—Ç—É.','–û–±—Å–º–∞–∂–∏—Ç–∏ –±–µ–∫–æ–Ω.','–ó–º—ñ—à–∞—Ç–∏ –∑ —è–π—Ü–µ–º —Ç–∞ —Å–∏—Ä–æ–º.']},
 // –ù–æ–≤—ñ —Ä–µ—Ü–µ–ø—Ç–∏
 {id:'r8',title:'–ì–æ—Å—Ç—Ä–∏–π —Å—É–ø –†–∞–º–µ–Ω (–®–≤–∏–¥–∫–∏–π)',ingredients:['–ª–æ–∫—à–∏–Ω–∞ —à–≤–∏–¥–∫–æ–≥–æ –ø—Ä–∏–≥–æ—Ç—É–≤–∞–Ω–Ω—è','—è–π—Ü—è','–∑–µ–ª–µ–Ω–∞ —Ü–∏–±—É–ª—è','—Å–æ—É—Å —à—Ä—ñ—Ä–∞—á–∞'],time:8,difficulty:'–õ–µ–≥–∫–æ',diet:[],categories:['oriental','spicy','quick'],steps:['–ó–∞–≤–∞—Ä–∏—Ç–∏ –ª–æ–∫—à–∏–Ω—É. –î–æ–¥–∞—Ç–∏ –≤—Å—ñ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏ —Ç–∞ –≥–æ—Å—Ç—Ä–∏–π —Å–æ—É—Å.']},
 {id:'r9',title:'–ì—Ä–µ—á–∫–∞ –ø–æ-—Å—Ö—ñ–¥–Ω–æ–º—É',ingredients:['–≥—Ä–µ—á–∫–∞','–∫—É—Ä—è—á–µ —Ñ—ñ–ª–µ','—Å–æ—î–≤–∏–π —Å–æ—É—Å','–º–æ—Ä–∫–≤–∞'],time:35,difficulty:'–°–µ—Ä–µ–¥–Ω—å–æ',diet:['glutenfree'],categories:['oriental'],steps:['–ó–≤–∞—Ä–∏—Ç–∏ –≥—Ä–µ—á–∫—É. –û–±—Å–º–∞–∂–∏—Ç–∏ –∫—É—Ä–∫—É —Ç–∞ –æ–≤–æ—á—ñ. –ó–º—ñ—à–∞—Ç–∏, –¥–æ–¥–∞—Ç–∏ —Å–æ—î–≤–∏–π —Å–æ—É—Å.']},
 {id:'r10',title:'–ö–∞–∑–∞–Ω –ø–ª–æ–≤—É (–Ω–∞ —Ç–∏–∂–¥–µ–Ω—å)',ingredients:['—Ä–∏—Å','–º º—è—Å–æ','–º–æ—Ä–∫–≤–∞','—Ü–∏–±—É–ª—è','—Ä–æ—Å–ª–∏–Ω–Ω–∞ –æ–ª—ñ—è','—Å–ø–µ—Ü—ñ—ó'],time:120,difficulty:'–í–∞–∂–∫–æ',diet:[],categories:['oriental'],steps:['–ü—ñ–¥–≥–æ—Ç—É–≤–∞—Ç–∏ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏, –æ–±—Å–º–∞–∂–∏—Ç–∏ –º º—è—Å–æ.','–î–æ–¥–∞—Ç–∏ —Ä–∏—Å, –∑–∞–ª–∏—Ç–∏ –≤–æ–¥–æ—é, –≤–∞—Ä–∏—Ç–∏ –¥–æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—ñ.','–†–æ–∑–¥—ñ–ª–∏—Ç–∏ –ø–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞—Ö ‚Äî —ó–∂–∞ –Ω–∞ —Ç–∏–∂–¥–µ–Ω—å.']}
];

/* ---------- DOM ---------- */
const overlay = document.getElementById('overlay');
const steps = { welcome: document.getElementById('step-welcome'), meal: document.getElementById('step-meal'), cooker: document.getElementById('step-cooker'), summary: document.getElementById('step-summary') };
const mealNextBtn = document.getElementById('meal-next'), cookerNextBtn = document.getElementById('cooker-next');
const toMeal = document.getElementById('to-meal'), finishBtn = document.getElementById('finish');
const summaryEl = document.getElementById('summary');
const funMsg = document.getElementById('fun-msg');
const app = document.getElementById('app');
const selectedMealLabel = document.getElementById('selected-meal');
const selectedCookerLabel = document.getElementById('selected-cooker');
const speedCurrentText = document.getElementById('speed-current-text');
const speedBadgeText = document.getElementById('speed-text');

/* ---------- App DOM ---------- */
const chips = document.getElementById('chips'), input = document.getElementById('ingredient-input'), results = document.getElementById('results');
const shoppingList = document.getElementById('shopping-list'), favList = document.getElementById('favorites-list'), historySection = document.getElementById('history');
const findBtn = document.getElementById('find-btn'), clearBtn = document.getElementById('clear-btn'), searchInput = document.getElementById('search-input');
const randomBtn = document.getElementById('random-btn'), themeToggle = document.getElementById('theme-toggle'), reopenDialog = document.getElementById('reopen-dialog');
const filterDiff = document.getElementById('filter-diff');
const quickCookerSelect = document.getElementById('quick-cooker-select');
const categoryFilterList = document.getElementById('category-filter-list'); // NEW category list element

/* ---------- State & persistence ---------- */
let selected = new Set();
let shopping = new Set(JSON.parse(localStorage.getItem('dk_shop')||'[]'));
let favs = new Set(JSON.parse(localStorage.getItem('dk_fav')||'[]'));
let likes = new Map(JSON.parse(localStorage.getItem('dk_likes')||'[]'));
if(!(likes instanceof Map)) likes = new Map(likes);

// Initialize with stored or default values
let chosenMeal = localStorage.getItem('dk_meal') || '';
let chosenCooker = localStorage.getItem('dk_cooker') || 'pan'; // default to pan if not set
let chosenSpeed = localStorage.getItem('dk_speed') || 'normal'; // speed: fast / normal / slow
let activeCategoryFilter = localStorage.getItem('dk_category_filter') || ''; // NEW active category filter

/* ---------- Helpers ---------- */
function persistSet(key, set){ localStorage.setItem('dk_'+key, JSON.stringify([...set])); }
function persistLikes(){ localStorage.setItem('dk_likes', JSON.stringify([...likes])); }
function persistSettings(){
    localStorage.setItem('dk_meal', chosenMeal);
    localStorage.setItem('dk_cooker', chosenCooker);
    localStorage.setItem('dk_speed', chosenSpeed);
    localStorage.setItem('dk_category_filter', activeCategoryFilter); // Persist category filter
}

/* ---------- Render UI ---------- */
function renderChips(){
  chips.innerHTML = '';
  [...selected].forEach(i=>{
    const el = document.createElement('span'); el.className='chip';
    el.innerHTML = `${i} <button title="–≤–∏–¥–∞–ª–∏—Ç–∏">‚úï</button>`;
    el.querySelector('button').onclick = ()=>{ selected.delete(i); renderChips(); };
    chips.appendChild(el);
  });
}

function renderShopping(){ shoppingList.innerHTML = [...shopping].length ? [...shopping].map(i=>`<li>${i}</li>`).join('') : '<li>–ü–æ—Ä–æ–∂–Ω—å–æ</li>'; persistSet('shop', shopping); }
function renderFavs(){ favList.innerHTML = [...favs].length ? [...favs].map(id=>{ let r = RECIPES.find(x=>x.id===id); return `<li>${r? r.title : id}</li>` }).join('') : '<li>–ü—É—Å—Ç–æ</li>'; persistSet('fav', favs); }
function renderHist(){ let h = JSON.parse(localStorage.getItem('dk_hist')||'[]'); historySection.innerHTML = '<h4>–ù–µ–¥–∞–≤–Ω—ñ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏</h4>' + (h.length ? h.map(x=>`<div class="chip" style="margin:6px 6px 0 0">${x}</div>`).join('') : '<div class="muted">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö</div>'); }

function updateHeaderLabels(){
    selectedMealLabel.textContent = chosenMeal || '‚Äî';
    selectedCookerLabel.textContent = chosenCooker || '‚Äî';
}

function updateQuickCookerUI(){
    // Update selected state in the Quick Cooker section
    quickCookerSelect.querySelectorAll('.option').forEach(o => {
        o.classList.remove('selected');
        if (o.dataset.val === chosenCooker) {
            o.classList.add('selected');
        }
    });
}

function updateCategoryFilterUI(){
    // Update selected state in the Category Filter section
    categoryFilterList.querySelectorAll('.option').forEach(o => {
        o.classList.remove('selected');
        if (o.dataset.val === activeCategoryFilter) {
            o.classList.add('selected');
        }
    });
}

/* ---------- Ingredients ---------- */
function addIngredient(text){
  text.split(',').map(s=>s.trim().toLowerCase()).filter(Boolean).forEach(x=>{ selected.add(x); saveHistory(x); });
  input.value=''; renderChips();
}
input.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); addIngredient(input.value); showRecipes(); } });

function saveHistory(item){
  let h = JSON.parse(localStorage.getItem('dk_hist')||'[]');
  h = h.filter(x=>x!==item); h.unshift(item); if(h.length>12) h=h.slice(0,12);
  localStorage.setItem('dk_hist', JSON.stringify(h)); renderHist();
}

/* ---------- Recipes logic ---------- */
function showRecipes(){
  const sel = [...selected];
  const search = (searchInput.value||'').toLowerCase();
  const dietFilters = [...document.querySelectorAll('.diet:checked')].map(cb=>cb.value);
  // const categoryFilters = [...document.querySelectorAll('.category:checked')].map(cb=>cb.value); // Old checkbox logic, replaced by activeCategoryFilter

  let prep = RECIPES.map(r=>{
    const matched = r.ingredients.filter(i=>selected.has(i));
    const miss = r.ingredients.filter(i=>!selected.has(i));
    const score = (matched.length / r.ingredients.length) + ((likes.get(r.id) || 0) * 0.2);
    return {...r, matched, miss, score};
  });

  // SPEED & COOKER LOGIC
  if(chosenSpeed==='fast') prep = prep.map(r=> ({...r, score: r.score + (r.time<=25?0.15: r.id==='r10' ? -0.8 : -0.4)}));
  if(chosenSpeed==='slow') prep = prep.map(r=> ({...r, score: r.score + (r.time>40?0.12:0)}));
  if(chosenCooker==='kazan') prep = prep.map(r=> ({...r, score: r.score + (r.id==='r10'?0.6:0)}));
  // Special cooker logic for Ramens / quick items if only 'none' (kettle) is selected
  if(chosenCooker==='none') prep = prep.map(r=> ({...r, score: r.score + (r.id==='r8'?0.5: r.time > 15 ? -0.5 : 0.1)})); 


  // Filters
  if(sel.length) prep = prep.filter(r=>r.matched.length>0);
  if(search) prep = prep.filter(r=>r.title.toLowerCase().includes(search));
  if(filterDiff.value) prep = prep.filter(r=>r.difficulty === filterDiff.value);
  if(dietFilters.length) prep = prep.filter(r=>dietFilters.every(d=>r.diet.includes(d)));
  
  // Apply the SINGLE active category filter
  if(activeCategoryFilter) prep = prep.filter(r=>r.categories.includes(activeCategoryFilter)); 

  prep.sort((a,b)=>b.score - a.score);

  results.innerHTML = prep.length ? '' : '<div class="panel">–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ... –ú–æ–∂–µ, —á–∞—Å —Å—Ö–æ–¥–∏—Ç–∏ –≤ –º–∞–≥–∞–∑–∏–Ω? ü•≤</div>';
  prep.forEach(r=>{
    const card = document.createElement('div'); card.className='card';
    card.innerHTML = `<div class="thumb">${getEmoji(r.id)}</div>
      <div class="title">${r.title}</div>
      <div class="meta">‚è± ${r.time} —Ö–≤ ‚Ä¢ ${r.difficulty} ‚Ä¢ ${r.categories.map(c => getCategoryEmoji(c)).join(' ')}</div>
      <div class="missing">${r.miss.length ? '–ü–æ—Ç—Ä—ñ–±–Ω–æ: ' + r.miss.join(', ') : '‚úÖ –£—Å–µ —î ‚Äî –≤—Ä–∞–∂–∞–π —Å—É—Å—ñ–¥—ñ–≤!'}</div>
      <div class="actions">
        <button class="small" data-act="shop">üõí</button>
        <button class="small" data-act="fav">${favs.has(r.id) ? '‚òÖ' : '‚òÜ'}</button>
        <button class="small" data-act="like">üëç</button>
        <button class="small" data-act="dislike">üëé</button>
      </div>
      <div class="match">${Math.round(r.score*100)}%</div>
    `;    
    card.querySelector('[data-act="shop"]').onclick = ()=>{ r.miss.forEach(m=>shopping.add(m)); renderShopping(); };
    card.querySelector('[data-act="fav"]').onclick = ()=>{ if(favs.has(r.id)) favs.delete(r.id); else favs.add(r.id); renderFavs(); showRecipes(); };
    card.querySelector('[data-act="like"]').onclick = ()=>{ likes.set(r.id, (likes.get(r.id)||0)+1); persistLikes(); showRecipes(); };
    card.querySelector('[data-act="dislike"]').onclick = ()=>{ likes.set(r.id, (likes.get(r.id)||0)-1); persistLikes(); showRecipes(); };
    card.ondblclick = ()=> openModal(r);
    card.oncontextmenu = (e)=>{ e.preventDefault(); openStep(r); };
    results.appendChild(card);
  });
}

/* ---------- Emoji mapping ---------- */
function getEmoji(id){ return {r1:"üç≥",r2:"ü•ò",r3:"üçù",r4:"ü•ó",r5:"üçó",r6:"üç≥",r7:"üçù",r8:"üçú",r9:"üçö",r10:"ü•£"}[id]||"üç¥"; }
function getCategoryEmoji(cat){
    return {
        oriental: 'üèÆ',
        spicy: 'üå∂Ô∏è',
        quick: 'üöÄ',
        student: 'üéì'
    }[cat] || '';
}

/* ---------- Modals (unchanged) ---------- */
function openModal(r){
  const o = document.createElement('div'); o.style = "position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:99999";
  const b = document.createElement('div'); b.style = "background:var(--panel);padding:20px;border-radius:12px;max-width:720px;width:92%;color:var(--text)";
  b.innerHTML = `<h3>${r.title}</h3><div style="color:var(--muted)">‚è± ${r.time} —Ö–≤ ‚Ä¢ ${r.difficulty}</div><hr style="border:none;border-top:1px solid rgba(255,255,255,0.04)"><ol style="margin:12px 0 0 18px">${r.steps.map(s=>`<li style="margin-bottom:8px">${s}</li>`).join('')}</ol><div style="margin-top:14px;display:flex;gap:8px;justify-content:flex-end"><button id="close-modal" class="btn btn-ghost">–ó–∞–∫—Ä–∏—Ç–∏</button></div>`;
  o.appendChild(b); document.body.appendChild(o);
  document.getElementById('close-modal').onclick = ()=> o.remove();
}

function openStep(r){
  let step = 0;
  const o = document.createElement('div'); o.style = "position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:99999";
  const b = document.createElement('div'); b.style = "background:var(--panel);padding:20px;border-radius:12px;max-width:520px;width:92%;color:var(--text);text-align:center";
  const text = document.createElement('div'); text.style = "margin-bottom:14px"; text.textContent = r.steps[step];
  const btn = document.createElement('button'); btn.className = 'btn btn-accent'; btn.textContent = '–ù–∞—Å—Ç—É–ø–Ω–∏–π';
  btn.onclick = ()=>{ if(step < r.steps.length-1){ step++; text.textContent = r.steps[step]; } else o.remove(); };
  b.append(text, btn); o.appendChild(b); document.body.appendChild(o);
}

/* ---------- Random button (unchanged) ---------- */
randomBtn.onclick = ()=> {
  const jokes = ["üé≤ –î–æ–ª—è –≤–∏—Ä—ñ—à–∏–ª–∞: –≥–æ—Ç—É–π —â–æ—Å—å —Å–º–∞—á–Ω–µ!", "–•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫ –∫–∞–∂–µ: —è –ø–æ—Ä–æ–∂–Ω—ñ–π, –∞–ª–µ —Ç–∏ –º–æ–∂–µ—à —â–æ—Å—å –ø—Ä–∏–¥—É–º–∞—Ç–∏ üòÖ", "–ü–æ—Ä–∞ —Ç–≤–æ—Ä–∏—Ç–∏! –Ø –≤–∏–±–∏—Ä–∞—é —Å—Ç—Ä–∞–≤—É –∑–∞ —Ç–µ–±–µ..."];
  alert(jokes[Math.floor(Math.random()*jokes.length)]);
  const r = RECIPES[Math.floor(Math.random()*RECIPES.length)];
  selected = new Set(r.ingredients); renderChips(); showRecipes();
};

/* ---------- Event bindings (updated) ---------- */
findBtn.onclick = ()=> showRecipes();
clearBtn.onclick = ()=>{ selected.clear(); renderChips(); results.innerHTML=''; };
searchInput.oninput = showRecipes;
filterDiff.onchange = showRecipes; // Rerun filter on difficulty change
document.querySelectorAll('.diet').forEach(cb=>cb.onchange = showRecipes); 

// theme toggle (works now)
const themeBtn = document.getElementById('theme-toggle');
function applyThemeClass(){
  if(localStorage.getItem('dk_theme') === 'light'){ document.body.classList.add('light'); themeBtn.textContent='üåû'; }
  else { document.body.classList.remove('light'); themeBtn.textContent='üåô'; }
}
applyThemeClass();
themeBtn.onclick = ()=>{
  if(document.body.classList.contains('light')){ document.body.classList.remove('light'); localStorage.setItem('dk_theme','dark'); themeBtn.textContent='üåô'; }
  else { document.body.classList.add('light'); localStorage.setItem('dk_theme','light'); themeBtn.textContent='üåû'; }
};

/* ---------- Dialog logic (mostly unchanged) ---------- */
function switchStep(from, to){
  if(from) from.classList.remove('active'); if(to) to.classList.add('active');
}

toMeal.onclick = ()=> { switchStep(steps.welcome, steps.meal); };
let mealChosen = null;
document.querySelectorAll('#meal-options .option').forEach(o=>{
  o.onclick = ()=>{
    document.querySelectorAll('#meal-options .option').forEach(x=>x.classList.remove('selected'));
    o.classList.add('selected'); mealChosen = o.dataset.val; mealNextBtn.disabled = false;
  };
});
mealNextBtn.onclick = ()=>{
  chosenMeal = mealChosen || '';
  updateHeaderLabels();
  // fun message
  funMsg.textContent = chosenMeal === 'breakfast' ? '–°–Ω—ñ–¥–∞–Ω–æ–∫ ‚Äî –Ω–µ –ø—Ä–æ—Å–ø–∏ –ø–∞—Ä—É!' : chosenMeal === 'lunch' ? '–û–±—ñ–¥ ‚Äî —á–∞—Å –Ω–∞—Å–∏—â–∞—Ç–∏—Å—å!' : chosenMeal === 'dinner' ? '–í–µ—á–µ—Ä—è ‚Äî —Ç–∏—Ö–æ, —â–æ–± –Ω–µ –±—É–¥–∏—Ç–∏ —Å—É—Å—ñ–¥—ñ–≤' : '–ù—ñ—á–Ω–∞ –ª–∏—Ö–æ–º–∞–Ω–∫–∞ ‚Äî –≥–æ—Ç—É–π –Ω–∞ —Å–æ–≤—ñ—Å—Ç—å';
  switchStep(steps.meal, steps.cooker);
};

let cookerChosen = null;
document.querySelectorAll('#cooker-options .option').forEach(o=>{
  o.onclick = ()=>{
    document.querySelectorAll('#cooker-options .option').forEach(x=>x.classList.remove('selected'));
    o.classList.add('selected'); cookerChosen = o.dataset.val; cookerNextBtn.disabled = false;
    const hints = {
      gas: '–û–≥–æ, –≥–∞–∑–æ–≤–∞ –ø–ª–∏—Ç–∞? –¢–∏ –º–∞–π–∂–µ —à–µ–π—Ö —É –≥—É—Ä—Ç–æ–∂–∏—Ç–∫—É! üí∏',
      electric: '–ï–ª–µ–∫—Ç—Ä–∏—á–Ω–∞ ‚Äî —Å—Ç–∞–±—ñ–ª—å–Ω–æ —ñ –ø–æ-—Ü—ñ–Ω–∏–≤—Å—å–∫–∏.',
      pan: '–ü–∞—Ç–µ–ª—å–Ω—è ‚Äî —É–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∏–π —Å–æ–ª–¥–∞—Ç.',
      pot: '–ö–∞—Å—Ç—Ä—É–ª—è ‚Äî —Ç–µ, —â–æ —Ç—Ä–µ–±–∞ –¥–ª—è —Å—É–ø—ñ–≤ —ñ —Ä–∞–≥—É.',
      multi: '–ú—É–ª—å—Ç–∏–≤–∞—Ä–∫–∞ ‚Äî –≤–∞–∂–∫–∞ –∞—Ä—Ç–∏–ª–µ—Ä—ñ—è –¥–ª—è –ª–µ–¥–∞—á–∏—Ö –∫–æ—Ä–æ–ª—ñ–≤.',
      kazan: '–ö–∞–∑–∞–Ω! –ì–æ—Ç—É–π –ø–ª–æ–≤ –Ω–∞ —Ç–∏–∂–¥–µ–Ω—å ‚Äî —Å—É—Å—ñ–¥–∏ –∑–∞–∑–¥—Ä—è—Ç—å.',
      micro: '–ú—ñ–∫—Ä–æ—Ö–≤–∏–ª—å–æ–≤–∫–∞ ‚Äî —à–≤–∏–¥–∫–æ, –∞–ª–µ –Ω–µ –∑–∞–≤–∂–¥–∏ —Å–º–∞—á–Ω–æ.',
      none: '–¢—ñ–ª—å–∫–∏ —á–∞–π–Ω–∏–∫? –ë—É–¥–µ —Ç–≤–æ—Ä—á–æ!'
    };
    document.getElementById('cooker-hint').textContent = hints[cookerChosen] || '';
  };
});

// speed options
let speedChosen = 'normal';
document.getElementById('speed-fast').onclick = ()=> selectSpeed('fast', true);
document.getElementById('speed-normal').onclick = ()=> selectSpeed('normal', true);
document.getElementById('speed-slow').onclick = ()=> selectSpeed('slow', true);
function selectSpeed(s, updateDialog = false){
  speedChosen = s; chosenSpeed = s;
  // Update UI in dialog and main
  document.querySelectorAll('#step-cooker .options .option').forEach(x=>x.classList.remove('selected'));
  if(updateDialog){
      if(s==='fast') document.getElementById('speed-fast').classList.add('selected');
      if(s==='normal') document.getElementById('speed-normal').classList.add('selected');
      if(s==='slow') document.getElementById('speed-slow').classList.add('selected');
  }

  document.getElementById('speed-text').textContent = s==='fast' ? '–ü–æ–±—ã—Å—Ç—Ä–µ–µ' : s==='slow' ? '–ü–æ–≤—ñ–ª—å–Ω–æ' : '–ù–æ—Ä–º–∞–ª—å–Ω–æ';
  document.getElementById('speed-current-text').textContent = document.getElementById('speed-text').textContent;
  persistSettings();
}

cookerNextBtn.onclick = ()=>{
  chosenCooker = cookerChosen || 'pan';
  updateHeaderLabels();
  updateQuickCookerUI(); // Initial update for quick cooker selector
  selectSpeed(chosenSpeed); // Ensure speed is correctly applied
  summaryEl.textContent = `–¢–∏ –æ–±—Ä–∞–≤: ${chosenMeal || '‚Äî'}; –≥–æ—Ç—É–≤–∞—Ç–∏–º–µ—à –Ω–∞: ${chosenCooker || '‚Äî'}; —à–≤–∏–¥–∫—ñ—Å—Ç—å ‚Äî ${chosenSpeed}.`;
  switchStep(steps.cooker, steps.summary);
};

finishBtn.onclick = ()=>{
  overlay.style.display = 'none';
  // Final checks and settings save
  chosenCooker = chosenCooker || 'pan'; // Final fallback
  persistSettings();
  
  // small fun final message
  if(chosenCooker==='kazan'){ funMsg.textContent = '–ö–∞–∑–∞–Ω –æ–±—Ä–∞–Ω–æ ‚Äî –≥–æ—Ç—É–π –ø–ª–æ–≤ –Ω–∞ —Ç–∏–∂–¥–µ–Ω—å! –Ø –ø—ñ–¥—Å–≤—ñ—Ç–ª—é –π–æ–≥–æ —É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö.'; }
  else if(chosenCooker==='gas'){ funMsg.textContent = '–ì–∞–∑ —î ‚Äî —Ç–∏ –∫–æ—Ä–æ–ª—å –≥—É—Ä—Ç–æ–∂–∏—Ç–∫—É!'; }
  else funMsg.textContent = '–ì–æ—Ç–æ–≤–æ ‚Äî –ø—Ä–∏—Å—Ç—É–ø–∞–π –¥–æ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç—ñ–≤!';
  
  updateQuickCookerUI(); // Apply final cooker choice to sidebar
  updateCategoryFilterUI(); // Apply initial category state
  selectSpeed(chosenSpeed);
  app.style.opacity = 1; app.style.transform = 'none';
  // show recipes initial
  showRecipes();
};

/* ---------- Reopen dialog (unchanged) ---------- */
reopenDialog.onclick = ()=>{
  overlay.style.display = 'flex';
  // reset overlay steps to welcome
  for(let k in steps){ steps[k].classList.remove('active'); }
  steps.welcome.classList.add('active');
};

/* ---------- UI speed from sidebar (unchanged) ---------- */
document.getElementById('ui-speed-fast').onclick = ()=> { selectSpeed('fast'); showRecipes(); };
document.getElementById('ui-speed-normal').onclick = ()=> { selectSpeed('normal'); showRecipes(); };
document.getElementById('ui-speed-slow').onclick = ()=> { selectSpeed('slow'); showRecipes(); };

/* ---------- Quick Cooker Change Logic (Feedback/–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å) ---------- */
quickCookerSelect.querySelectorAll('.option').forEach(o => {
    o.onclick = () => {
        chosenCooker = o.dataset.val;
        updateHeaderLabels();
        updateQuickCookerUI();
        persistSettings();
        showRecipes(); // Rerun recipe filter with new cooker
        
        // Update fun message with new cooker context
        const funHints = {
            gas: '–ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è: –ì–∞–∑ —î ‚Äî —Ç–∏ –∫–æ—Ä–æ–ª—å –≥—É—Ä—Ç–æ–∂–∏—Ç–∫—É!',
            electric: '–ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è: –ï–ª–µ–∫—Ç—Ä–∏–∫–∞ ‚Äî –Ω–∞–¥—ñ–π–Ω—ñ—Å—Ç—å —É —Ç–≤–æ—ó—Ö —Ä—É–∫–∞—Ö.',
            pot: '–ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è: –ö–∞—Å—Ç—Ä—É–ª—è ‚Äî —á–∞—Å –¥–ª—è —Å—É–ø—É —á–∏ —Ä–∞–≥—É!',
            pan: '–ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è: –ü–∞—Ç–µ–ª—å–Ω—è ‚Äî —É–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∏–π –≤–∏–±—ñ—Ä.',
            micro: '–ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è: –ú—ñ–∫—Ä–æ—Ö–≤–∏–ª—å–æ–≤–∫–∞ ‚Äî —Å—É–ø–µ—Ä—à–≤–∏–¥–∫–æ.',
            none: '–ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è: –¢—ñ–ª—å–∫–∏ —á–∞–π–Ω–∏–∫ ‚Äî –º—ñ–Ω—ñ–º–∞–ª—ñ–∑–º!',
            kazan: '–ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è: –ö–∞–∑–∞–Ω! –í–∂–µ —á—É—é –∑–∞–ø–∞—Ö –ø–ª–æ–≤—É.',
            multi: '–ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è: –ú—É–ª—å—Ç–∏–≤–∞—Ä–∫–∞ ‚Äî –¥–ª—è –ª–µ–¥–∞—á–∏—Ö –∫–æ—Ä–æ–ª—ñ–≤.',
        };
        funMsg.textContent = funHints[chosenCooker] || '–í–∏–±—ñ—Ä –ø–æ—Å—É–¥—É –∑–º—ñ–Ω–µ–Ω–æ. –ì–æ—Ç—É—î–º–æ!';
    };
});

/* ---------- Category Filter Logic (New sidebar section) ---------- */
categoryFilterList.querySelectorAll('.option').forEach(o => {
    o.onclick = () => {
        const selectedCategory = o.dataset.val;
        
        // Toggle logic: if the same category is clicked, turn off the filter
        if (activeCategoryFilter === selectedCategory) {
            activeCategoryFilter = '';
        } else {
            activeCategoryFilter = selectedCategory;
        }

        updateCategoryFilterUI(); // Update visual state
        persistSettings();
        showRecipes(); // Rerun recipe filter
        
        if (activeCategoryFilter) {
            funMsg.textContent = `–í–≤—ñ–º–∫–Ω–µ–Ω–æ —Ñ—ñ–ª—å—Ç—Ä: ${o.textContent.trim()}. –ì–æ—Ç—É–π —â–æ—Å—å –æ—Å–æ–±–ª–∏–≤–µ!`;
        } else {
            funMsg.textContent = '–§—ñ–ª—å—Ç—Ä –∫–∞—Ç–µ–≥–æ—Ä—ñ–π –≤–∏–º–∫–Ω–µ–Ω–æ. –î–∏–≤–∏–º–æ—Å—è –≤—Å—ñ —Ä–µ—Ü–µ–ø—Ç–∏.';
        }
    };
});


/* ---------- Initialize saved state & render ---------- */
function init(){
  renderShopping(); renderFavs(); renderHist(); renderChips();
  // apply last theme
  if(localStorage.getItem('dk_theme') === 'light'){ document.body.classList.add('light'); document.getElementById('theme-toggle').textContent='üåû' }
  else document.getElementById('theme-toggle').textContent='üåô';
  
  // If settings exist, hide dialog and show app immediately
  if (chosenMeal || chosenCooker !== 'pan') { // Check if user completed the initial flow before
      overlay.style.display = 'none';
      app.style.opacity = 1; app.style.transform = 'none';
      updateHeaderLabels();
      updateQuickCookerUI();
      updateCategoryFilterUI(); // Apply category state on init
      selectSpeed(chosenSpeed);
      funMsg.textContent = '–†–∞–¥—ñ—Å–Ω–æ –∑–Ω–æ–≤—É –±–∞—á–∏—Ç–∏ —Ç–µ–±–µ! –ü–æ—á–Ω—ñ–º–æ –≥–æ—Ç—É–≤–∞—Ç–∏.';
      showRecipes();
  } else {
      // Show app hidden until dialog finished
      app.style.opacity = 0; app.style.transform = 'translateY(8px)';
  }
}
init();

/* ---------- Save on unload (updated) ---------- */
window.addEventListener('beforeunload', ()=>{ persistSet('shop', shopping); persistSet('fav', favs); persistLikes(); persistSettings(); });

</script>
<script>
async function loadRecipes() {
  const response = await fetch("/recipes");
  const data = await response.json();
  const container = document.getElementById("recipeContainer");
  container.innerHTML = "";

  data.forEach(recipe => {
    const card = document.createElement("div");
    card.classList.add("recipe-card");
    card.innerHTML = `
      <h3>${recipe.title}</h3>
      <p>–ß–∞—Å: ${recipe.time_minutes} —Ö–≤</p>
      <p>–°–∫–ª–∞–¥–Ω—ñ—Å—Ç—å: ${recipe.difficulty}</p>
    `;
    container.appendChild(card);
  });
}

window.onload = loadRecipes;
</script>

</body>
</html>